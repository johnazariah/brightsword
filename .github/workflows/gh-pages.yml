name: Build and publish docs to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-docs:
    name: Build docs artifacts (reusable build-and-test)
    uses: ./.github/workflows/build-and-test.yml
    with:
      configuration: 'Release'

  publish-docs:
    name: Publish docs to gh-pages
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-artifacts
          path: artifacts/docs

      - name: Verify docs artifact
        run: |
          echo "Verifying artifacts/docs exists and is not empty"
          if [ ! -d "artifacts/docs" ]; then echo "No docs found at artifacts/docs"; exit 1; fi
          COUNT=$(find artifacts/docs -type f | wc -l)
          echo "Files found: $COUNT"
          if [ "$COUNT" -eq "0" ]; then echo "No files in artifacts/docs"; exit 1; fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./artifacts/docs
